<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Werewolf Online (Sheets)</title>
  <style>
    :root{--bg:#0b1020;--card:#0f172a;--muted:#94a3b8;--text:#e2e8f0;--accent:#22c55e;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1000px 500px at 50% -200px,#1e293b,var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1000px;margin:auto;padding:24px}
    h1{margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.15);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:16px}
    .bd{padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button,select{background:#0b1325;color:var(--text);border:1px solid rgba(148,163,184,.25);border-radius:12px;padding:10px 12px}
    button{cursor:pointer}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.25)}
    .btn.primary{background:var(--accent);color:#052e16;border-color:transparent;font-weight:600}
    .btn.danger{background:var(--danger);color:#3b0a0a;border-color:transparent}
    .btn.warn{background:var(--warn);color:#3b2410;border-color:transparent}
    .list{display:grid;gap:8px}
    .li{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--card);border:1px solid rgba(148,163,184,.15);border-radius:12px}
    .tag{padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.25);font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(148,163,184,.18);margin:10px 0}
    .role{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:#0b1325}
    .role.wr{border-color:rgba(239,68,68,.6)}
    .role.vl{border-color:rgba(34,197,94,.6)}
    .role.se{border-color:rgba(59,130,246,.6)}
    .role.dc{border-color:rgba(245,158,11,.7)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Werewolf Online (Sheets)</h1>
    <div class="sub">Masukkan URL Apps Script → Host cipta room → Pemain join → Host mula game → Poll state.</div>

    <div class="card"><div class="bd">
      <div class="row">
        <label>Apps Script URL</label>
        <input id="endpoint" placeholder="https://script.google.com/macros/s/AKfycb.../exec" style="min-width:340px" />
        <button class="btn" onclick="saveEndpoint()">Simpan</button>
        <span class="tag">Disimpan di pelayar ini</span>
      </div>
    </div></div>

    <div class="card"><div class="bd">
      <h2>Host</h2>
      <div class="row">
        <button class="btn primary" onclick="createRoom()">Cipta Room</button>
        <span class="tag">Room: <b id="roomCode">-</b></span>
        <span class="tag">Status: <b id="roomStatus">-</b></span>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn warn" onclick="startGame()">Mula Game</button>
        <button class="btn" onclick="setNight()">Set Malam</button>
        <button class="btn" onclick="setDay()">Set Siang</button>
        <select id="killSelect"></select>
        <button class="btn danger" onclick="killSelected()">Bunuh</button>
      </div>
      <div class="hr"></div>
      <div>Host Key (disimpan tempatan): <code id="hostKey">-</code></div>
    </div></div>

    <div class="card"><div class="bd">
      <h2>Pemain</h2>
      <div class="row">
        <input id="joinRoom" placeholder="Room Code" />
        <input id="playerName" placeholder="Nama" />
        <button class="btn primary" onclick="join()">Join</button>
        <span class="tag">Player ID: <b id="playerId">-</b></span>
        <button class="btn" onclick="revealMyRole()">Lihat Peranan Saya</button>
        <span id="myRole" class="role"></span>
      </div>
    </div></div>

    <div class="card"><div class="bd">
      <div class="row">
        <button class="btn" onclick="beginPollPrompt()">Mula Poll State</button>
        <button class="btn" onclick="stopPoll()">Henti Poll</button>
        <span class="tag">Versi: <b id="ver">-</b></span>
      </div>
      <div class="hr"></div>
      <h3>Senarai Pemain</h3>
      <div id="players" class="list"></div>
    </div></div>
  </div>

<script>
let ENDPOINT = localStorage.getItem('endpoint') || '';
const $ = (q)=>document.querySelector(q);
$('#endpoint').value = ENDPOINT;
function saveEndpoint(){ ENDPOINT=$('#endpoint').value.trim(); localStorage.setItem('endpoint', ENDPOINT); alert('Endpoint disimpan'); }

// IMPORTANT: text/plain to avoid preflight CORS in Apps Script
async function api(action, payload={}){
  if(!ENDPOINT) throw new Error('Setkan Apps Script URL dahulu');
  const res = await fetch(ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({action, ...payload})
  });
  let data=null; try{ data = await res.json(); }catch(e){ const t=await res.text(); throw new Error('Gagal parse JSON: '+t.slice(0,200)); }
  return data;
}

// Host
async function createRoom(){
  const r = await api('createRoom', {});
  if(!r.ok){ alert(r.error||'Ralat'); return; }
  localStorage.setItem('roomCode', r.roomCode);
  localStorage.setItem('hostKey', r.hostKey);
  $('#roomCode').textContent = r.roomCode;
  $('#roomStatus').textContent = r.room?.status || '-';
  $('#hostKey').textContent = r.hostKey;
}
async function startGame(){
  const roomCode = localStorage.getItem('roomCode');
  const hostKey = localStorage.getItem('hostKey');
  const r = await api('start', {roomCode, hostKey});
  if(!r.ok){ alert(r.error||'Ralat'); return; }
}
async function setDay(){ await api('update', {roomCode:localStorage.getItem('roomCode'), hostKey:localStorage.getItem('hostKey'), status:'day'}); }
async function setNight(){ await api('update', {roomCode:localStorage.getItem('roomCode'), hostKey:localStorage.getItem('hostKey'), status:'night'}); }
async function killSelected(){
  const pid = $('#killSelect').value; if(!pid) return;
  await api('update', {roomCode:localStorage.getItem('roomCode'), hostKey:localStorage.getItem('hostKey'), killPlayerId:pid});
}

// Player
async function join(){
  const roomCode = $('#joinRoom').value.trim().toUpperCase();
  const name = $('#playerName').value.trim();
  if(!roomCode || !name) return alert('Isi room code & nama.');
  const r = await api('join', {roomCode, name});
  if(!r.ok){ alert(r.error||'Ralat'); return; }
  localStorage.setItem('playerId', r.playerId);
  localStorage.setItem('roomCode', roomCode);
  $('#playerId').textContent = r.playerId;
}
async function revealMyRole(){
  const roomCode = localStorage.getItem('roomCode');
  const playerId = localStorage.getItem('playerId');
  if(!roomCode||!playerId) return alert('Join dahulu.');
  const r = await api('getMyRole', {roomCode, playerId});
  if(!r.ok){ alert(r.error||'Ralat'); return; }
  showRole(r.role||'');
}
function showRole(role){
  const x=$('#myRole'); x.className='role'; x.textContent='';
  if(!role) return; const cls={Werewolf:'wr',Villager:'vl',Seer:'se',Doctor:'dc'}[role]||''; x.classList.add(cls); x.textContent=role;
}

// Polling
let pollTimer=null;
function beginPollPrompt(){ const rc = prompt('Room code?', localStorage.getItem('roomCode')||''); if(!rc) return; beginPoll(rc); }
function beginPoll(roomCode){ stopPoll(); pollTimer=setInterval(async ()=>{ const r = await api('getState', {roomCode}); if(r.ok) renderState(r.state); }, 1200); }
function stopPoll(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

function renderState(state){
  $('#roomStatus').textContent = state.room.status;
  $('#ver').textContent = state.room.version;
  $('#roomCode').textContent = state.room.roomCode;
  const list=$('#players'); list.innerHTML='';
  const sel=$('#killSelect'); sel.innerHTML='';
  (state.players||[]).forEach(p=>{
    const li=document.createElement('div'); li.className='li';
    const left=document.createElement('div'); left.textContent=p.name;
    const right=document.createElement('div'); right.innerHTML = `<span class="tag">${p.alive? 'Hidup':'Mati'}</span>`;
    li.append(left,right); list.append(li);
    const o=document.createElement('option'); o.value=p.playerId; o.textContent=`${p.name} ${p.alive?'':'(mati)'}`; sel.appendChild(o);
  });
}

// Restore
(function(){
  const rc=localStorage.getItem('roomCode'); if(rc) $('#roomCode').textContent=rc;
  const hk=localStorage.getItem('hostKey'); if(hk) $('#hostKey').textContent=hk;
  const pid=localStorage.getItem('playerId'); if(pid) $('#playerId').textContent=pid;
})();
</script>
</body>
</html>
